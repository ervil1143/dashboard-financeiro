<!DOCTYPE html>
<html lang="pt-PT">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Financeiro</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background:#0f172a; color:#e5e7eb; margin:0; }
    header { padding:20px; background:#111827; display:flex; justify-content:space-between; align-items:center; }
    .button { background:#1f2937; color:#e5e7eb; padding:10px 14px; border-radius:8px; cursor:pointer; border:1px solid #334155; }
    .grid { display:grid; grid-template-columns:repeat(2,1fr); gap:20px; padding:20px; }
    .card { background:#111827; padding:20px; border-radius:10px; }
    canvas { width:100%!important; height:300px!important; }
  </style>
</head>
<body>
  <header>
    <h1>Dashboard Financeiro</h1>
    <label class="button">
      üìÅ Importar ficheiro
      <input id="fileInput" type="file" style="display:none" accept=".csv,.xlsx,.xls" />
    </label>
  </header>

  <main class="grid">
    <section class="card"><h2>Receitas vs Despesas</h2><canvas id="chartBar"></canvas></section>
    <section class="card"><h2>Distribui√ß√£o por Categoria</h2><canvas id="chartPie"></canvas></section>
    <section class="card"><h2>Evolu√ß√£o Mensal</h2><canvas id="chartLine"></canvas></section>
    <section class="card"><h2>Distribui√ß√£o por √Årea</h2><canvas id="chartArea"></canvas></section>
  </main>

  <script>
    const state = { rows:[], charts:{} };

    function parseDate(s){
      const parts = s.split('/');
      if(parts.length===3) return new Date(parts[2], parts[1]-1, parts[0]);
      return new Date(s);
    }

    function currency(n){ return n.toLocaleString('pt-PT',{style:'currency',currency:'EUR'}); }

    async function handleFile(file){
      const ext=file.name.toLowerCase();
      if(ext.endsWith('.csv')){
        const text=await file.text();
        parseCSV(text);
      } else {
        const data=await file.arrayBuffer();
        const wb=XLSX.read(data,{type:'array'});
        const ws=wb.Sheets[wb.SheetNames[0]];
        const json=XLSX.utils.sheet_to_json(ws,{defval:''});
        parseJSONRows(json);
      }
    }

    function parseCSV(text){
      const sep=text.includes(';')?';':',';
      const lines=text.split(/\r?\n/).filter(l=>l.trim().length);
      const headers=lines[0].split(sep).map(h=>h.trim().toLowerCase());
      const idx={
        categoria:headers.findIndex(h=>h.includes('categoria')),
        movimentos:headers.findIndex(h=>h.includes('movimento')),
        area:headers.findIndex(h=>h.includes('area')),
        data:headers.findIndex(h=>h.includes('data')),
        valor:headers.findIndex(h=>h.includes('valor'))
      };
      const rows=[];
      for(let i=1;i<lines.length;i++){
        const cols=lines[i].split(sep);
        rows.push({
          data:cols[idx.data],
          categoria:cols[idx.categoria],
          area:cols[idx.area],
          movimentos:cols[idx.movimentos],
          valor:parseFloat(String(cols[idx.valor]).replace(',','.'))
        });
      }
      normalizeAndLoad(rows);
    }

    function parseJSONRows(json){
      const rows=json.map(r=>({
        data:r["Data"],
        categoria:r["Categoria"],
        area:r["Area"]||r["√Årea"],
        movimentos:r["Movimentos"],
        valor:parseFloat(String(r["Valor"]).replace(',','.'))
      }));
      normalizeAndLoad(rows);
    }

    function normalizeAndLoad(rows){
      state.rows=rows.map(r=>({
        data:parseDate(r.data),
        categoria:r.categoria||"Sem categoria",
        area:r.area||"Sem √°rea",
        tipo:r.movimentos.toLowerCase().includes("entrada")?"receita":"despesa",
        valor:r.valor||0
      }));
      renderAll();
    }

    function renderAll(){
      const receitas=state.rows.filter(r=>r.tipo==="receita");
      const despesas=state.rows.filter(r=>r.tipo==="despesa");

      // Receitas vs Despesas por m√™s
      const byMonth={};
      state.rows.forEach(r=>{
        const key=`${r.data.getFullYear()}-${String(r.data.getMonth()+1).padStart(2,'0')}`;
        if(!byMonth[key]) byMonth[key]={receita:0,despesa:0};
        if(r.tipo==="receita") byMonth[key].receita+=r.valor;
        else byMonth[key].despesa+=r.valor;
      });
      const months=Object.keys(byMonth).sort();
      const receitaMensal=months.map(m=>byMonth[m].receita);
      const despesaMensal=months.map(m=>byMonth[m].despesa);

      upsertChart("chartBar","bar",{
        labels:months,
        datasets:[
          {label:"Receitas",data:receitaMensal,backgroundColor:"#10b981"},
          {label:"Despesas",data:despesaMensal,backgroundColor:"#ef4444"}
        ]
      });

      // Pie por categoria (despesas)
      const catMap={};
      despesas.forEach(r=>catMap[r.categoria]=(catMap[r.categoria]||0)+r.valor);
      upsertChart("chartPie","doughnut",{
        labels:Object.keys(catMap),
        datasets:[{data:Object.values(catMap),backgroundColor:["#ef4444","#f59e0b","#6366f1","#22d3ee","#10b981"]}]
      });

      // Linha saldo acumulado
      let saldo=0;
      const saldoAcumulado=months.map(m=>{
        saldo+=byMonth[m].receita-byMonth[m].despesa;
        return saldo;
      });
      upsertChart("chartLine","line",{
        labels:months,
        datasets:[{label:"Saldo acumulado",data:saldoAcumulado,borderColor:"#22d3ee",fill:true}]
      });

      // Distribui√ß√£o por √°rea
      const areaMap={};
      despesas.forEach(r=>areaMap[r.area]=(areaMap[r.area]||0)+r.valor);
      upsertChart("chartArea","bar",{
        labels:Object.keys(areaMap),
        datasets:[{label:"Despesas por √°rea",data:Object.values(areaMap),backgroundColor:"#f59e0b"}]
      });
    }

    function upsertChart(id,type,data){
      const ctx=document.getElementById(id);
      if(state.charts[id]){ state.charts[id].data=data; state.charts[id].update(); }
      else { state.charts[id]=new Chart(ctx,{type,data}); }
    }

    document.getElementById("fileInput").addEventListener("change",e=>{
      const f=e.target.files[0];
      if(f) handleFile(f);
    });
  </script>
</body>
</html>
